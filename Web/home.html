<html>
	<head>
		<title>lighght</title>
		<script src="static/js/jquery-2.0.3.min.js" type="text/javascript"></script>
		<script src="static/js/oj.js" type="text/javascript"></script>
		<link href="static/stylesheets/bemis100_oj.css" rel='stylesheet' type='text/css'>
		<meta name="viewport" content="width=device-width">
	</head>
	<body>
	</body>
	<script>
		function add_pattern(name, isfolder) {
			if (isfolder) {
				var params = {folder: name, beat: false};
			} else {
				var params = {pattern: name, beat: false};
			}
			$('.current').oj(function() {
				show_pattern('/static/img/loading.gif');
			});
			$.getJSON('/add', params, function(result) {
				update_view();
			});
		}
		function on_play(evt) {
			$('.play-btn').css({display:'none'});
			$('.pause-btn').css({display:'inline'});
			$.getJSON('/play', function(result){update_view();});
		}
		function on_pause(evt) {
			$('.pause-btn').css({display:'none'});
			$('.play-btn').css({display:'inline'});
			$.getJSON('/pause', function(result){update_view();});
		}
		function on_clear(evt) {
			add_pattern('_off.png', false);
		}
		function show_pattern_button(pat) {
			oj.div({c:'pattern-block pointer', click:function() {add_pattern(pat.name, false)}}, function () {
				oj.div(function () {
					oj.img({src:pat.thumb, class:'pattern-thumb'});
				});
				oj.div(function () {
					oj.img({src:pat.preview, class:'pattern-preview'});
				});
			});
		};
		function show_pattern(thumb) {
			oj.div({c:'pattern-block'}, function() {
				oj.div(function () {
					oj.img({src:thumb, class:'pattern-thumb'});
				});
			});
		};
		function show_group(grp) {
			oj.div({c:'pattern-group'}, function () {
				oj.div({c:'pattern-group-header'}, function() {
					if (grp.name) {
						oj.span(grp.name + ': ' ,{c:'text-label group-label'});
					} else {
						oj.span("All Patterns :",{c:'text-label group-label'});
					}
					oj.a('Shuffle', {c:'text-label shuffle-btn', href:'#',click:function(evt) {add_pattern(grp.name+'/_mix.png', true)}});
				});
				// oj.h2(grp.name,{c:'text-label'});
				for (var i = 0; i < grp.patterns.length; i++) {
					show_pattern_button(grp.patterns[i]);
				};
			});
		};
		function show_current(current) {
			if (current===null) {
				oj.div({c:'queue-placeholder pattern-block'}, function() {
					oj.span('Nothing playing');
				});
			} else {
				show_pattern(current.thumb);
			}
		};
		function update_view() {
			$.getJSON('/status', function(result) {
				controller_status = result['controller_status'];
				$('.current').oj(function() {show_current(controller_status.current)});
				if (controller_status.playing) {
					$('.play-btn').css({display:'none'});
					$('.pause-btn').css({display:'inline'});
				} else {
					$('.play-btn').css({display:'inline'});
					$('.pause-btn').css({display:'none'});
				}
			});
		};
		function run_timed_update() {
			update_view();
			setTimeout(run_timed_update, 2000);
		}
		function update_patterns(pattern_groups) {
			$.getJSON('/pattern_groups', function(result) {
				pattern_groups = result['pattern_groups'];
				console.log(pattern_groups);
				$('.all-patterns').oj(function () {
					// oj.span('All Patterns', {c:'text-label'});
					for (var i = 0; i < pattern_groups.length; i++) {
						show_group(pattern_groups[i]);
					}
				});
			});
		}
	$('body').oj(function () {
			oj.div({c: 'container'}, function() {
				oj.div({c: 'header'}, function() {
					oj.span({c: 'title'}, 'lighght');
				});
				oj.div({c: 'current-and-queue'}, function() {
					oj.span('Now Playing:', {c:'now-playing-label'});
					oj.div({c: 'current-holder'}, function () {
						oj.div({c: 'current'});
					});
					oj.div({c: 'play-controls'}, function() {
						oj.div({c: 'play-controls-inner'}, function() {
							oj.div({c: 'control-btn', click:on_clear}, 'Clear');
							oj.div({c: 'control-btn play-btn', click:on_play}, 'Play');
							oj.div({c: 'control-btn pause-btn',click:on_pause}, 'Pause');
						});
					});
				});
				oj.div({c:'all-patterns'});
			});
		});
		update_patterns();
		update_view();
		run_timed_update();
	</script>
</html>
